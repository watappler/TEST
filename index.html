<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Adjektivdeklination Trainer</title>
  <style>
    :root{--bg:#f8fafc;--card:#ffffff;--ink:#0f172a;--muted:#475569;--ring:#e2e8f0;--accent:#2563eb}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#f8fafc,#fff);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP",sans-serif;color:var(--ink)}
    .wrap{max-width:980px;margin:20px auto;padding:0 16px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .card{background:var(--card);border:1px solid var(--ring);border-radius:16px;box-shadow:0 1px 2px rgba(2,6,23,.05);padding:16px}
    h1{font-size:20px;margin:0 0 6px}
    .subtitle{color:var(--muted);font-size:13px;margin-bottom:14px}
    .seg{display:inline-flex;border:1px solid var(--ring);border-radius:10px;overflow:hidden}
    .seg button{border:0;background:#fff;padding:8px 12px;color:var(--muted);cursor:pointer}
    .seg button.active{background:var(--accent);color:#fff}
    .seg button:not(.active):hover{background:#f1f5f9}
    .question{font-size:22px;line-height:1.45;display:block;min-height:2.6em;position:relative;z-index:2}
    .blank{display:inline-block;min-width:3.6ch;border:2px dotted #94a3b8;border-radius:6px;padding:0 6px;margin:0 2px;line-height:1.2;background:#fff}
    .blank .underscore{display:block;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;line-height:1;white-space:nowrap;overflow:hidden;user-select:none}
    .ja{color:var(--muted);font-size:15px;margin-top:6px}
    .choices{display:flex;gap:10px;margin-top:14px;flex-wrap:nowrap;overflow:hidden;align-items:stretch;transform-origin:left center;will-change:transform;position:relative;z-index:1}
    .choices button{border:1px solid var(--ring);border-radius:12px;padding:0 12px;font-size:18px;background:#fff;cursor:pointer;white-space:nowrap;overflow:hidden;text-overflow:clip;line-height:1;height:52px;flex:1 1 0;display:flex;align-items:center;justify-content:center;min-width:0;transition:background-color .15s ease,border-color .15s ease,color .15s ease}
    .choices button:hover{background:#f8fafc;border-color:#cbd5e1}
    .choices button.correct{background:#d1fae5;border-color:#34d399;color:#065f46}
    .choices button.wrong{background:#ffe4e6;border-color:#fb7185;color:#9f1239}
    .meta{display:flex;gap:12px;flex-wrap:wrap;color:var(--muted);font-size:12px;margin-top:8px}
    .explain{margin-top:14px;padding:12px;border:1px dashed var(--ring);border-radius:12px;background:#fafafa}
    .result-full{margin-bottom:16px}
    .explain h3{margin:0 0 6px;font-size:16px}
    .explain .cols{display:grid;grid-template-columns:1fr max-content;column-gap:8px;align-items:stretch}
    .explain .cols .left{margin-top:0;display:flex;flex-direction:column}
    .explain .right{width:auto;display:flex;flex-direction:column;justify-content:flex-start;gap:4px;align-items:center;text-align:center;height:100%}
    .explain .right h3{text-align:center}
    .explain .right .sub-de{font-size:12px;color:#475569;margin:2px 0 4px}
    .explain .left .de{font-size:13px;color:#334155;margin-top:4px}
    .caseList{border:1px solid var(--ring);border-radius:8px;padding:4px;background:#fff;margin:2px auto 0;display:inline-block;text-align:left}
    .caseList .case{display:grid;grid-template-columns:minmax(0,1fr) 3em;align-items:center;column-gap:16px;border-bottom:1px dashed var(--ring);padding:2px 0}
    .caseList .case:last-child{border-bottom:0}
    .case .label{font-size:12px;color:var(--muted);line-height:1.1;text-align:left}
    .case .ending{font-weight:700;letter-spacing:.2px;white-space:nowrap;text-align:left;width:3em;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .footer{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .btn{border:1px solid var(--ring);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer;display:inline-flex;align-items:center;gap:0.4em;}
    .btn svg{width:1em;height:1em;stroke-width:2;}
    .btn.primary svg{stroke-width: 2.5;}
    .btn.tiny svg{width:1.1em;height:1.1em;}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .btn.tiny{padding:4px 8px;font-size:12px}
    .stat{margin-left:auto;color:var(--muted);font-size:14px; white-space:nowrap;}
    details.ref{border:1px dashed var(--ring);border-radius:12px;padding:10px;background:#fbfbff}
    details.ref>summary{list-style:none;cursor:pointer;font-weight:600;color:#1e3a8a}
    details.ref>summary::-webkit-details-marker{display:none}
    .ref-note{color:#475569;font-size:12px;margin-top:6px}
    .ref-tabs{display:flex;gap:6px;flex-wrap:wrap;margin:10px 0}
    .ref-tabs button{border:1px solid var(--ring);background:#fff;border-radius:999px;padding:6px 10px;font-size:12px;color:#334155;cursor:pointer}
    .ref-tabs button.active{background:#2577eb;border-color:#2577eb;color:#fff}
    .gender-tabs{display:flex;gap:6px;flex-wrap:wrap;margin:6px 0}
    .gender-tabs button{border:1px solid var(--ring);background:#fff;border-radius:8px;padding:6px 10px;font-size:12px;color:#334155;cursor:pointer}
    .gender-tabs button.active{background:#0ea5e9;border-color:#0ea5e9;color:#fff}
    .checks{display:flex;gap:8px;flex-wrap:wrap}
    #caseChecks{flex-wrap:nowrap;gap:6px}
    #caseChecks .chk{white-space:nowrap}
    .chk{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--ring);background:#fff;border-radius:999px;padding:6px 10px;font-size:12px;color:#334155}
    .chk input{accent-color:var(--accent)}
    .example{border:1px dashed var(--ring);border-radius:10px;padding:10px;background:#fff;margin-top:8px}
    .example h4{margin:0 0 6px;font-size:14px;color:#334155}
    table.ex-table{display:inline-table;width:auto;border-collapse:separate;border-spacing:0;margin-top:6px;table-layout:fixed;font-size:14px}
    table.ex-table th,table.ex-table td{border:1px solid var(--ring);padding:6px 8px;text-align:left;white-space:nowrap}
    .end{font-weight:700;padding:0 2px;border-radius:4px}
    .end.e{background:#fecdd3}
    .end.en{background:#e5e7eb}
    .end.em{background:#e0f2fe}
    .end.er{background:#ede9fe}
    .end.es{background:#fef3c7}
    table.ref-table{width:100%;border-collapse:separate;border-spacing:0;margin-top:8px}
    table.ref-table th,table.ref-table td{border:1px solid var(--ring);padding:8px 10px;text-align:center}
    table.ref-table th{background:#f1f5f9}
    .ref-table td.en-bg{background:#f3f4f6}
    .ref-table.hl-masculine th:nth-child(2){background:#eef2ff;color:#3730a3;box-shadow:inset 0 0 0 2px #6366f1;border-color:#6366f1}
    .ref-table.hl-neuter th:nth-child(3){background:#fffbeb;color:#7c2d12;box-shadow:inset 0 0 0 2px #fbbf24;border-color:#fbbf24}
    .ref-table.hl-feminine th:nth-child(4){background:#fff1f2;color:#9f1239;box-shadow:inset 0 0 0 2px #fb7185;border-color:#fb7185}
    .ref-table.hl-plural th:nth-child(5){background:#f5f3ff;color:#4c1d95;box-shadow:inset 0 0 0 2px #8b5cf6;border-color:#8b5cf6}

    @keyframes flash-th-masculine { 50% { background-color: #c7d2fe; border-color: #818cf8; filter: brightness(1.1); } }
    @keyframes flash-th-neuter { 50% { background-color: #fde68a; border-color: #f59e0b; filter: brightness(1.1); } }
    @keyframes flash-th-feminine { 50% { background-color: #fbcfe8; border-color: #f472b6; filter: brightness(1.1); } }
    @keyframes flash-th-plural { 50% { background-color: #d8b4fe; border-color: #a855f7; filter: brightness(1.1); } }

    .ref-table.hl-masculine th.flash { animation: flash-th-masculine 0.75s ease-out 1; }
    .ref-table.hl-neuter th.flash { animation: flash-th-neuter 0.75s ease-out 1; }
    .ref-table.hl-feminine th.flash { animation: flash-th-feminine 0.75s ease-out 1; }
    .ref-table.hl-plural th.flash { animation: flash-th-plural 0.75s ease-out 1; }

    @keyframes flash-cell-masculine { 50% { background-color: #dbeafe; border-color: #a5b4fc; filter: brightness(1.05); } }
    @keyframes flash-cell-neuter { 50% { background-color: #fef3c7; border-color: #fcd34d; filter: brightness(1.05); } }
    @keyframes flash-cell-feminine { 50% { background-color: #fee2e2; border-color: #fda4af; filter: brightness(1.05); } }
    @keyframes flash-cell-plural { 50% { background-color: #e9d5ff; border-color: #c084fc; filter: brightness(1.05); } }
    
    .ref-table.hl-masculine td:nth-child(2) { animation: flash-cell-masculine 0.75s ease-out 1; }
    .ref-table.hl-neuter td:nth-child(3) { animation: flash-cell-neuter 0.75s ease-out 1; }
    .ref-table.hl-feminine td:nth-child(4) { animation: flash-cell-feminine 0.75s ease-out 1; }
    .ref-table.hl-plural td:nth-child(5) { animation: flash-cell-plural 0.75s ease-out 1; }
    
    #tags{display:none}
    .badge{display:inline-block;padding:4px 12px;border-radius:999px;font-weight:700;font-size:14px;border:1px solid transparent}
    .badge.good{background:#dcfce7;border-color:#86efac;color:#065f46}
    .badge.bad{background:#fee2e2;border-color:#fecaca;color:#991b1b}
    .result-line{display:flex;gap:8px;align-items:center;flex-wrap:nowrap;white-space:nowrap}
    .result-line .badge{flex:0 0 auto}
    .result-line .filler{flex:1 1 auto;min-width:0;white-space:normal;overflow:visible;text-overflow:clip}
    .hint-pill{position:absolute;right:0;bottom:calc(100% + 4px);background:#eef2ff;color:#3730a3;border-radius:999px;padding:4px 10px;font-size:12px;white-space:nowrap}
    .actions{margin-left:auto;display:flex;gap:8px;align-items:center;position:relative}
    [hidden]{display:none!important}
    .footnotes{font-size:12px;color:var(--muted);margin-top:10px;padding-left:16px}
    .footnotes li{margin:2px 0}
    .ex-cell .ex-row{display:inline-flex;align-items:baseline;gap:6px}
    .ex-cell .ex-det{flex:0 0 var(--det-w,auto)}
    .ex-cell .ex-adj{flex:0 0 var(--adj-w,auto)}
    .ex-cell .ex-noun{flex:1 1 auto;min-width:0}
    .de-line{display:flex;gap:8px;align-items:baseline;flex-wrap:wrap}
    .decl-tag{display:inline-block;margin-left:6px;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--ring);background:#f8fafc}
    .decl-tag.weak{background:#e0f2fe;color:#075985;border-color:#bae6fd}
    .decl-tag.mixed{background:#fffbeb;color:#7c2d12;border-color:#fde68a}
    .decl-tag.strong{background:#fee2e2;color:#7f1d1d;border-color:#fecaca}
    .mix-wide{grid-column:1 / -1}
    .example .mix-title{font-size:16px;margin:0 0 6px}
    .example .mix-subtitle{font-size:13px;color:#334155;margin:-2px 0 8px}
    .choices button:disabled{opacity:1;cursor:default}
    #exampleView{display:inline-block;width:auto;max-width:100%}
    @media (max-width:480px){.ex-cell .ex-row{gap:4px}}
    .pulse{animation:pulseFlash .9s ease-out 1}
    @keyframes pulseFlash{0%{box-shadow:0 0 0 0 rgba(37,99,235,.35);transform:translateZ(0)}40%{box-shadow:0 0 0 10px rgba(0,0,0,0);transform:scale(1.01)}100%{box-shadow:0 0 0 0 rgba(0,0,0,0);transform:none}}
    .streak-badge{
        padding: 8px 18px;
        border-radius: 20px;
        font-weight: 700;
        font-size: 14px;
        border: 1px solid transparent;
        flex: 0 0 auto;
        white-space: normal;
        line-height: 1.4;
        text-align: center;
    }
    .streak-badge.tone-accent{background:#e8f0ff;border-color:#bfdbfe;color:#1e3a8a}
    .streak-badge.tone-purple{background:#f3e8ff;border-color:#e9d5ff;color:#6b21a8}
    .streak-badge.tone-indigo{background:#eef2ff;border-color:#c7d2fe;color:#3730a3}
    .streak-badge.tone-sky{background:#e0f2fe;border-color:#bae6fd;color:#075985}
    .streak-badge.tone-green{background:#dcfce7;border-color:#bbf7d0;color:#065f46}
    .streak-badge.tone-lime{background:#ecfccb;border-color:#d9f99d;color:#3f6212}
    .streak-badge.tone-yellow{background:#fef9c3;border-color:#fde68a;color:#7c2d12}
    .streak-badge.tone-orange{background:#ffedd5;border-color:#fed7aa;color:#9a3412}
    .streak-badge.tone-red{background:#fee2e2;border-color:#fecaca;color:#7f1d1d}
    .streak-badge.tone-black{background:#e5e7eb;border-color:#cbd5e1;color:#111827}
    .streak-badge.tone-silver{background:#f1f5f9;border-color:#cbd5e1;color:#334155}
    .streak-badge.tone-gold{background:#fef3c7;border-color:#fcd34d;color:#92400e}
    
    .streak-badge.tone-epic { background:#f3e8ff; border-color:#c084fc; color:#7e22ce; }
    .streak-badge.tone-legendary { background:#fff1f2; border-color:#f472b6; color:#be185d; }
    .streak-badge.tone-mythic { background:#e0f2fe; border-color:#7dd3fc; color:#0369a1; }
    .streak-badge.tone-godlike { background:#dcfce7; border-color:#86efac; color:#15803d; }
    .streak-badge.tone-meister { background: linear-gradient(145deg, #fefce8, #fef9c3); border-color:#facc15; color:#a16207; }

    #fullscreen-reward {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000;
      display: flex; align-items: center; justify-content: center;
      color: white; text-align: center; transition: opacity 0.5s ease;
      opacity: 0; pointer-events: none; overflow: hidden;
    }
    #fullscreen-reward.visible { opacity: 1; }
    #fullscreen-reward-content h1 { font-size: 4rem; font-weight: bold; animation: textGlow 1.5s ease-in-out infinite alternate; }
    #fullscreen-reward-content h1.silver { animation: textGlowSilver 1.5s ease-in-out infinite alternate; }
    @keyframes textGlow {
      from { text-shadow: 0 0 10px #fff, 0 0 20px #fff, 0 0 30px #facc15, 0 0 40px #facc15, 0 0 50px #facc15, 0 0 60px #facc15, 0 0 70px #facc15; }
      to { text-shadow: 0 0 20px #fff, 0 0 30px #fef08a, 0 0 40px #fef08a, 0 0 50px #fef08a, 0 0 60px #fef08a, 0 0 70px #fef08a, 0 0 80px #fef08a; }
    }
    @keyframes textGlowSilver {
      from { text-shadow: 0 0 10px #fff, 0 0 20px #e0e0e0, 0 0 30px #c0c0c0, 0 0 40px #c0c0c0, 0 0 50px #c0c0c0, 0 0 60px #c0c0c0, 0 0 70px #c0c0c0; }
      to { text-shadow: 0 0 20px #fff, 0 0 30px #dcdcdc, 0 0 40px #dcdcdc, 0 0 50px #dcdcdc, 0 0 60px #dcdcdc, 0 0 70px #dcdcdc, 0 0 80px #dcdcdc; }
    }
    
    .particle { position: absolute; }
    .petal { top: -20px; width: 15px; height: 15px; background-color: #ffb7c5; border-radius: 50% 0; animation: fall-and-sway 7s linear forwards; }
    .confetti { top: -20px; width: 8px; height: 15px; animation: fall-and-spin 7s linear forwards; }
    .snowflake { top: -20px; font-size: 20px; color: #fff; animation: fall-and-sway 12s linear infinite; }
    .explosion { position: absolute; width: 1px; height: 1px; }
    .explosion .particle { position: absolute; left: 0; top: 0; width: 8px; height: 8px; border-radius: 50%; animation: explode 1.2s ease-out forwards; }
    .bubble { border-radius: 50%; animation: float 10s linear forwards; border: 1px solid rgba(255,255,255,0.2); background: radial-gradient(circle at 65% 15%, white 1px, rgba(255,255,255,0.5) 3%, rgba(255,255,255,0.2) 30%, rgba(255,255,255,0.1) 100%); }
    
    @keyframes explode {
        0% { transform: translate(0, 0) scale(1); opacity: 1; }
        100% { transform: translate(var(--explode-x), var(--explode-y)) scale(0); opacity: 0; }
    }
    @keyframes fall-and-sway {
      0% { transform: translateY(-10vh) translateX(0) rotate(var(--r-start)); opacity: 1; }
      100% { transform: translateY(110vh) translateX(calc(var(--sway) * 2)) rotate(calc(var(--r-start) + 360deg)); opacity: 0; }
    }
    @keyframes fall-and-spin {
      0% { transform: translateY(0) rotateX(0) rotateY(0); opacity: 1; }
      100% { transform: translateY(110vh) rotateX(var(--rx)) rotateY(var(--ry)); opacity: 0; }
    }
    @keyframes float {
      0% { transform: translateY(0) translateX(0); opacity: 0.8; }
      25% { transform: translateY(-30vh) translateX(var(--wobble)); opacity: 0.9; }
      50% { transform: translateY(-60vh) translateX(calc(var(--wobble) * -1)); opacity: 1; }
      75% { transform: translateY(-90vh) translateX(var(--wobble)); opacity: 0.9; }
      100% { transform: translateY(-120vh) translateX(0); opacity: 0; }
    }

    #achievements { margin-bottom: 20px; }
    #achievements h2 { font-size: 16px; margin: 0 0 10px; color: var(--muted); border-bottom: 1px solid var(--ring); padding-bottom: 8px; }
    #trophy-case { display: flex; gap: 10px; flex-wrap: wrap; }
    .trophy-badge {
      background: linear-gradient(145deg, #fefce8, #fef9c3); border: 2px solid #facc15; border-radius: 12px;
      padding: 8px 12px; display: inline-flex; align-items: center; gap: 8px;
      color: #a16207; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.1), inset 0 1px 1px #fffbeb;
    }
    .trophy-badge svg { width: 24px; height: 24px; fill: #f59e0b; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="achievements" hidden>
      <h2>Sammlung</h2>
      <div id="trophy-case"></div>
    </div>
    <div class="card">
      <h1>Adjektivdeklination Trainer</h1>
      <div class="subtitle">形容詞格変化練習</div>
      <div class="row controls">
        <div class="seg" id="levelSeg" role="tablist" aria-label="level">
          <button data-level="All" class="active" aria-selected="true">ALL</button>
          <button data-level="A1+A2">A1+A2</button>
          <button data-level="B1">B1</button>
        </div>
        <div class="actions">
          <span class="hint-pill" id="preHint" hidden></span>
          <button class="btn tiny" id="preHintBtn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M15 14c.2-1 .7-1.7 1.5-2.5C17.7 10.2 18 9 18 7.5a6 6 0 0 0-12 0c0 1.5.3 2.7 1.5 3.9.8.8 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>
            <span>Tipp</span>
          </button>
          <button class="btn" id="again">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
            <span>Nochmal</span>
          </button>
          <button class="btn primary" id="next">
            <span>Weiter</span>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="13 17 18 12 13 7"></polyline><polyline points="6 17 11 12 6 7"></polyline></svg>
          </button>
        </div>
      </div>
    </div>

    <div class="card" id="quiz">
      <div class="meta" id="tags"></div>
      <div class="question" id="q" aria-live="polite"></div>
      <div class="ja" id="q-ja"></div>
      <div class="choices" id="choices"></div>
      <div class="explain" id="exp" hidden></div>
      <div class="footer">
        <span class="stat" id="stat">Siegesserie: 0 / Wiederholungen: 0</span>
      </div>
    </div>
    
    <div class="card" id="test-controls" style="margin-top:20px;" hidden>
      <h3 style="font-size:14px; color:var(--muted); margin:0 0 10px;">ご褒美動作テスト用（暫定）</h3>
      <div class="row" style="flex-wrap: wrap; gap: 8px;">
        <button class="btn tiny" id="test-streak-10">連続10回</button>
        <button class="btn tiny" id="test-streak-60">桜吹雪</button>
        <button class="btn tiny" id="test-confetti">紙吹雪</button>
        <button class="btn tiny" id="test-gold-silver">金銀吹雪</button>
        <button class="btn tiny" id="test-snowflakes">雪の結晶</button>
        <button class="btn tiny" id="test-bubbles">シャボン玉</button>
        <button class="btn tiny" id="test-fireworks">花火</button>
        <button class="btn tiny" id="test-streak-90">連続90回</button>
        <button class="btn tiny" id="test-streak-100">連続100回</button>
      </div>
    </div>

    <div class="card">
      <details class="ref" id="filterPanel">
        <summary>出題範囲（クリックで表示）</summary>
        <div class="row" style="gap: 8px; align-items: center; margin: 10px 0px; padding-bottom: 10px; border-bottom: 1px solid var(--ring);">
          <button class="btn tiny" id="selectAllFilters">Select All</button>
          <button class="btn tiny" id="clearAllFilters">Clear All</button>
        </div>
        <div class="row" style="gap:8px;align-items:flex-start;flex-wrap:wrap">
          <div style="min-width:220px">
            <div style="font-size:12px;color:#475569;margin-bottom:4px">格</div>
            <div class="checks" id="caseChecks">
              <label class="chk"><input type="checkbox" data-case="Nominativ" checked> <span>1格</span></label>
              <label class="chk"><input type="checkbox" data-case="Akkusativ" checked> <span>4格</span></label>
              <label class="chk"><input type="checkbox" data-case="Dativ" checked> <span>3格</span></label>
              <label class="chk"><input type="checkbox" data-case="Genitiv" checked> <span>2格</span></label>
            </div>
          </div>
          <div style="min-width:220px">
            <div style="font-size:12px;color:#475569;margin-bottom:4px">冠詞</div>
            <div class="checks" id="articleChecks">
              <label class="chk"><input type="checkbox" data-article="definite" checked> <span>定冠詞</span></label>
              <label class="chk"><input type="checkbox" data-article="indefinite" checked> <span>不定冠詞</span></label>
              <label class="chk"><input type="checkbox" data-article="none" checked> <span>無冠詞</span></label>
            </div>
          </div>
          <div style="min-width:220px">
            <div style="font-size:12px;color:#475569;margin-bottom:4px">性</div>
            <div class="checks" id="genderChecks">
              <label class="chk"><input type="checkbox" data-gender="masculine" checked> <span>男性名詞</span></label>
              <label class="chk"><input type="checkbox" data-gender="neuter" checked> <span>中性名詞</span></label>
              <label class="chk"><input type="checkbox" data-gender="feminine" checked> <span>女性名詞</span></label>
              <label class="chk"><input type="checkbox" data-gender="plural" checked> <span>複数形</span></label>
            </div>
          </div>
        </div>
      </details>
    </div>

    <div class="card">
      <details class="ref" id="refPanel">
        <summary>形容詞格変化 一覧表（クリックで表示）</summary>
        <div class="ref-tabs" role="tablist" aria-label="article-tabs">
          <button data-article="definite" class="active">定冠詞</button>
          <button data-article="indefinite">不定冠詞</button>
          <button data-article="none">無冠詞</button>
        </div>
        <div id="refControls" class="gender-tabs"></div>
        <div id="exampleView" class="example" hidden></div>
        <div id="refTableWrap"></div>
        <div class="ref-note">複数の不定は kein- や所有冠詞に準じる。</div>
      </details>
    </div>
  </div>
  <div id="fullscreen-reward" hidden></div>

<script>
  const MINI_TABLE={definite:{masculine:{Nominativ:"-e",Akkusativ:"-en",Dativ:"-en",Genitiv:"-en"},feminine:{Nominativ:"-e",Akkusativ:"-e",Dativ:"-en",Genitiv:"-en"},neuter:{Nominativ:"-e",Akkusativ:"-e",Dativ:"-en",Genitiv:"-en"},plural:{Nominativ:"-en",Akkusativ:"-en",Dativ:"-en",Genitiv:"-en"}},indefinite:{masculine:{Nominativ:"-er",Akkusativ:"-en",Dativ:"-en",Genitiv:"-en"},feminine:{Nominativ:"-e",Akkusativ:"-e",Dativ:"-en",Genitiv:"-en"},neuter:{Nominativ:"-es",Akkusativ:"-es",Dativ:"-en",Genitiv:"-en"},plural:{Nominativ:"-en",Akkusativ:"-en",Dativ:"-en",Genitiv:"-en"}},none:{masculine:{Nominativ:"-er",Akkusativ:"-en",Dativ:"-em",Genitiv:"-en"},feminine:{Nominativ:"-e",Akkusativ:"-e",Dativ:"-er",Genitiv:"-er"},neuter:{Nominativ:"-es",Akkusativ:"-es",Dativ:"-em",Genitiv:"-en"},plural:{Nominativ:"-e",Akkusativ:"-e",Dativ:"-en",Genitiv:"-er"}}};
  const LABEL_JP={article:{definite:"定冠詞（類）",indefinite:"不定冠詞（類）",none:"無冠詞"},gender:{masculine:"男性名詞",feminine:"女性名詞",neuter:"中性名詞",plural:"複数形"}};
  const CASE_ORDER=["Nominativ","Akkusativ","Dativ","Genitiv"];
  const GENDER_ORDER=["masculine","neuter","feminine","plural"];
  const GENDER_JP_SHORT={masculine:"男性",feminine:"女性",neuter:"中性",plural:"複数"};
  const ARTICLE_HEAD={definite:"定冠詞",indefinite:"不定冠詞",none:"無冠詞"};
  const ARTICLE_DE={definite:"bestimmter Artikel",indefinite:"unbestimmter Artikel",none:"Nullartikel"};
  const GENDER_DE={masculine:"Maskulinum",feminine:"Femininum",neuter:"Neutrum",plural:"Plural"};
  const CASE_DE={Nominativ:"Nominativ",Akkusativ:"Akkusativ",Dativ:"Dativ",Genitiv:"Genitiv"};
  const CASE_ABBR={Nominativ:"Nom.",Akkusativ:"Akk.",Dativ:"Dat.",Genitiv:"Gen."};
  const ARTICLE_DE_SHORT = {definite:"Best. Art.", indefinite:"Unbest. Art.", none:"Nullart."};
  const GENDER_DE_SHORT = {masculine:"Mask.", feminine:"Fem.", neuter:"Neut.", plural:"Plur."};
  const CASE_JP_NUM={Nominativ:"1格",Akkusativ:"4格",Dativ:"3格",Genitiv:"2格"};
  const LEVEL_CASES={"All":["Nominativ","Akkusativ","Dativ","Genitiv"],"A1+A2":["Nominativ","Akkusativ","Dativ"],"B1":["Genitiv"]};

  const ITEMS = [
    {"sentence":"Der kluge Mann liest eine Zeitung.","adj":"kluge","correct":"kluge","choices":["kluge","kluger","klugen"],"kase":"Nominativ","gender":"masculine","article":"definite","level":"A1","jp":"その賢い男性は新聞を読んでいます。"},
    {"sentence":"Der alte Stuhl steht in der Ecke.","adj":"alte","correct":"alte","choices":["alte","alten","altes"],"kase":"Nominativ","gender":"masculine","article":"definite","level":"A1","jp":"その古い椅子は隅に置いてあります。"},
    {"sentence":"Der neue Computer funktioniert gut.","adj":"neue","correct":"neue","choices":["neue","neuer","neuen"],"kase":"Nominativ","gender":"masculine","article":"definite","level":"A1","jp":"その新しいコンピューターは正常に動作します。"},
  ];

  const DETERMINER={definite:{masculine:{Nominativ:'der',Akkusativ:'den',Dativ:'dem',Genitiv:'des'},neuter:{Nominativ:'das',Akkusativ:'das',Dativ:'dem',Genitiv:'des'},feminine:{Nominativ:'die',Akkusativ:'die',Dativ:'der',Genitiv:'der'},plural:{Nominativ:'die',Akkusativ:'die',Dativ:'den',Genitiv:'der'}},indefinite:{masculine:{Nominativ:'ein',Akkusativ:'einen',Dativ:'einem',Genitiv:'eines'},neuter:{Nominativ:'ein',Akkusativ:'ein',Dativ:'einem',Genitiv:'eines'},feminine:{Nominativ:'eine',Akkusativ:'eine',Dativ:'einer',Genitiv:'einer'},plural:{nominativ:'meine',Akkusativ:'meine',Dativ:'meinen',Genitiv:'meiner'}},none:{masculine:{Nominativ:'',Akkusativ:'',Dativ:'',Genitiv:''},neuter:{Nominativ:'',Akkusativ:'',Dativ:'',Genitiv:''},feminine:{Nominativ:'',Akkusativ:'',Dativ:'',Genitiv:''},plural:{Nominativ:'',Akkusativ:'',Dativ:'',Genitiv:''}}};
  const EXAMPLE_NOUNS={default:{masculine:{base:'Wein',gen:'Weins'},neuter:{base:'Brot',gen:'Brotes'},feminine:{base:'Milch',gen:'Milch'},plural:{base:'Freunde',datpl:'Freunden',genpl:'Freunde'}},indefinite:{masculine:{base:'Vater',gen:'Vaters'},neuter:{base:'Kind',gen:'Kindes'},feminine:{base:'Mutter',gen:'Mutter'},plural:{base:'Freunde',datpl:'Freunden',genpl:'Freunde'}}};
  const ADJ_STEM='gut';
  let state={level:'All',pool:[],order:[],idx:0,correct:0,total:0,streak:0,retries:0,filters:{cases:{Nominativ:true,Akkusativ:true,Dativ:true,Genitiv:true},articles:{definite:true,indefinite:true,none:true},genders:{masculine:true,neuter:true,feminine:true,plural:true}}};
  let currentArticle='definite';
  let currentGender='masculine';
  let EX_GLOBAL=null;
  let readAndApply;
  let questionAnsweredCorrectly = false;
  let sprachmeisterUnlocked = false;

  // --- Core Functions ---
  function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
  function isLetter(c){return /[A-Za-zÄÖÜäöüß]/.test(c||'')}
  function endClassFrom(e){const n=e.replace('-','');return['e','en','em','er','es'].includes(n)?n:'e'}
  
  // --- UI Update Functions ---
  function showError(t){const q=document.getElementById('q'),j=document.getElementById('q-ja'),c=document.getElementById('choices'),e=document.getElementById('exp');if(q)q.innerHTML='<span style="color:#b91c1c">⚠ '+t+'</span>';if(j)j.textContent='';if(c)c.innerHTML='';if(e){e.hidden=true;e.innerHTML=''}}
  function updateStat(){document.getElementById('stat').textContent=`Siegesserie: ${state.streak} / Wiederholungen: ${state.retries}`}

  function fillAllBlanks(){
    const UNDER_CHAR='＿';
    let __UNDER_CHAR_WIDTH=null;
    function __getUnderCharWidth(){if(__UNDER_CHAR_WIDTH){return __UNDER_CHAR_WIDTH}const m=document.createElement('span');m.style.cssText='position:absolute;left:-9999px;top:-9999px;visibility:hidden;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;line-height:1';m.textContent=UNDER_CHAR;document.body.appendChild(m);__UNDER_CHAR_WIDTH=m.getBoundingClientRect().width||8;document.body.removeChild(m);return __UNDER_CHAR_WIDTH}
    document.querySelectorAll('.blank').forEach(e=>{const u=e.querySelector('.underscore');if(!u)return;const s=getComputedStyle(e),i=e.clientWidth-(parseFloat(s.paddingLeft)||0)-(parseFloat(s.paddingRight)||0),c=Math.max(2,Math.floor(i/(__getUnderCharWidth())));u.textContent=UNDER_CHAR.repeat(c)})
  }
  
  function formatQuestionHTMLFull(s,a){const t=String(s||''),l=String(a||'');if(!t||!l)return t;if(t.startsWith(l)){return `<span class="blank" style="--blank-ch:${Math.max(l.length,5)}" aria-label="空欄"><span class="underscore"></span></span>`+t.slice(l.length)}let i=t.indexOf(' '+l);while(i!==-1){const b=i>0?t[i-1]:'',f=t[i+l.length+1]||'';if(!isLetter(b)&&!isLetter(f)){const c=Math.max(l.length,5);return t.slice(0,i+1)+'<span class="blank" style="--blank-ch:'+c+'" aria-label="空欄"><span class="underscore"></span></span>'+t.slice(i+l.length+1)}i=t.indexOf(' '+l,i+1)}return t.replace(l,`<span class="blank" style="--blank-ch:${Math.max(l.length,5)}" aria-label="空欄"><span class="underscore"></span></span>`)}

  function fitChoiceText(){document.querySelectorAll('#choices button').forEach(b=>{let f=18;b.style.fontSize=f+'px';const l=Math.max(10,Math.min(18,Math.floor((b.clientWidth||80)/10)));let g=14;while(g-->0&&b.scrollWidth>b.clientWidth){f-=1;if(f<l)break;b.style.fontSize=f+'px'}})}
  function scaleChoices(){const c=document.getElementById('choices');if(!c)return;c.style.transform='none';const a=c.clientWidth;let f=0;Array.from(c.children).forEach((e,i)=>{f+=e.offsetWidth;if(i>0)f+=10});const s=f>0?Math.min(1,a/f):1;c.style.transformOrigin='left center';c.style.transform=`scale(${s})`}

  // --- Quiz Logic ---
  function validateItem(i){return i&&typeof i.sentence==='string'&&typeof i.adj==='string'&&Array.isArray(i.choices)&&i.choices.length===3&&new Set(i.choices).size===3&&typeof i.correct==='string'&&i.choices.includes(i.correct)&&i.kase&&i.gender&&i.article?i:null}
  function buildPool(){const a=LEVEL_CASES[state.level]||CASE_ORDER;let p=ITEMS.map(validateItem).filter(Boolean).filter(i=>a.includes(i.kase));p=p.filter(i=>state.filters.cases[i.kase]&&state.filters.articles[i.article]&&state.filters.genders[i.gender]);if(p.length===0){const f={cases:{Nominativ:true,Akkusativ:false,Dativ:false,Genitiv:false},articles:{definite:true,indefinite:false,none:false},genders:{masculine:true,neuter:false,feminine:false,plural:false}};p=ITEMS.filter(i=>f.cases[i.kase]&&f.articles[i.article]&&f.genders[i.gender])}state.pool=p;state.order=shuffle([...Array(p.length).keys()]);state.idx=0;state.total=0;state.correct=0}

  function render(){
    questionAnsweredCorrectly=false;
    try{
      if(state.idx>=state.order.length){ buildPool() }
      if(!state.pool||!state.pool.length){ showError('出題範囲に一致する問題がありません。上の「出題範囲」を確認してください。'); updateStat(); return }
      const o=state.order[state.idx];
      if(typeof o==='undefined'){ showError('内部エラー：問題の読み込みに失敗しました。'); return }
      const item=state.pool[o];
      if(!item){ showError('内部エラー：問題データが見つかりません。'); return }
      
      const qEl=document.getElementById('q'), jaEl=document.getElementById('q-ja'), choicesEl=document.getElementById('choices'), expEl=document.getElementById('exp');
      expEl.hidden=true; expEl.innerHTML='';
      
      const shown=formatQuestionHTMLFull(item.sentence,item.adj);
      qEl.innerHTML=shown;
      fillAllBlanks();
      if(!qEl.textContent||qEl.textContent.trim()===''){ qEl.textContent=item.sentence }
      if(jaEl){ jaEl.textContent=item.jp||''; jaEl.hidden=!item.jp }
      
      const preHintBtn=document.getElementById('preHintBtn'), preHint=document.getElementById('preHint');
      if(preHint){ preHint.hidden=true; preHint.style.display='none'; preHint.textContent=`${ARTICLE_DE_SHORT[item.article]}・${GENDER_DE_SHORT[item.gender]}・${CASE_ABBR[item.kase]}` }
      if(preHintBtn){ preHintBtn.disabled=false; preHintBtn.onclick=()=>{if(preHint){preHint.hidden=false;preHint.style.display='inline-block'}preHintBtn.disabled=true} }
      
      const opts=shuffle(item.choices.map(f=>({val:f,text:f})));
      choicesEl.innerHTML='';
      opts.forEach(o=>{ const b=document.createElement('button'); b.textContent=o.text; b.dataset.val=o.val; b.addEventListener('click',()=>grade(item,o)); choicesEl.appendChild(b) });
      
      document.getElementById('next').onclick=()=>{ if(!questionAnsweredCorrectly)state.streak=0; state.idx++; state.total++; render(); updateStat(); fitChoiceText(); scaleChoices() };
      document.getElementById('again').onclick=()=>{ state.retries++; render(); fitChoiceText(); scaleChoices() };
      
      updateStat(); fitChoiceText(); requestAnimationFrame(scaleChoices)
    } catch(err){ console.error(err); showError('実行時エラー：'+(err&&err.message?err.message:'原因不明')) }
  }

  function grade(item,picked){
    const buttons=Array.from(document.getElementById('choices').children);
    buttons.forEach(b=>b.disabled=true);
    const correctFull=item.correct;
    const isCorrect=picked.val===correctFull;
    buttons.forEach(btn=>{const v=btn.dataset.val;if(v===correctFull)btn.classList.add('correct');if(v===picked.val)btn.classList.add(isCorrect?'correct':'wrong')});
    
    if(isCorrect){
      if(!questionAnsweredCorrectly){
        state.streak++;
        const s = state.streak;
        if (s === 100) {
          triggerPulse(s); showFullscreenReward(); unlockSprachmeisterBadge();
        } else if (s === 90) {
          triggerPulse(s); show90StreakReward();
        } else if (s >= 50 && s < 90 && s % 10 === 0) {
          triggerPulse(s);
          if (s >= 60) {
            const container = document.getElementById('fullscreen-reward');
            if(container){
              container.innerHTML=''; container.style.background='transparent'; container.style.pointerEvents='none';
              container.hidden=false; void container.offsetWidth; container.classList.add('visible');
              showCherryBlossoms();
              setTimeout(()=>{container.classList.remove('visible');container.innerHTML='';container.hidden=true}, 10000);
            }
          }
        } else {
          triggerPulse(s);
        }
      }
      questionAnsweredCorrectly=true;
    }
    updateStat();
    
    const expEl=document.getElementById('exp');
    const tableData=(MINI_TABLE[item.article]&&MINI_TABLE[item.article][item.gender])?MINI_TABLE[item.article][item.gender]:null;
    const streakHtml=isCorrect?buildStreakBadge(state.streak):'';
    const mark=isCorrect?`<span class="badge good">✔ 正解</span>${streakHtml}`:`<span class="badge bad">✘ 不正解</span>`;
    const declKind=item.article==='definite'?'weak':item.article==='indefinite'?'mixed':'strong';
    const declLabel=declKind==='weak'?'弱変化':declKind==='mixed'?'混合変化':'強変化';
    
    const hintJPText=`<strong>${ARTICLE_HEAD[item.article]}</strong> ＋ <strong>${GENDER_JP_SHORT[item.gender]}名詞</strong> ＋ <strong>${CASE_JP_NUM[item.kase]}</strong> の組み合わせです。`;
    const btnsHtml=`<div class="de-line"><span class="de">${buildGermanHint(item)}</span></div>`;
    const rightHtml=`<aside class="right"><h3>${ARTICLE_HEAD[item.article]}・${GENDER_JP_SHORT[item.gender]}</h3><div class="sub-de">${ARTICLE_DE[item.article]} ・<br>${GENDER_DE[item.gender]}</div>${buildRightCaseList(tableData)||'<p>（参照表なし）</p>'}</aside>`;

    expEl.innerHTML=`
      <div class="result-full">
        <h3>正解・和訳</h3>
        <p class="result-line">${mark}<span class="filler"></span></p>
        <p>正しい文：<strong>${item.sentence}</strong></p>
        <p>和訳：${item.jp||''}</p>
      </div>
      <div class="cols">
        <div class="left" style="min-width:0">
          <h3>解説 <span class="decl-tag ${declKind}">${declLabel}</span></h3>
          <p>${hintJPText}</p>
          ${btnsHtml}
        </div>
        ${rightHtml}
      </div>`;
    expEl.hidden=false;
    const footnotesHTML=buildFootnotes(item);
    if(footnotesHTML){const tmp=document.createElement('div');tmp.innerHTML=footnotesHTML;const node=tmp.firstElementChild;if(node)expEl.appendChild(node)}
    
    currentArticle=item.article;
    currentGender=item.gender;
    mountRef(currentArticle);
  }
  
  // --- Reference Table & Examples ---
  function buildGermanHint(i){const e=MINI_TABLE[i.article][i.gender][i.kase];return`${ARTICLE_DE[i.article]} + ${GENDER_DE[i.gender]} + ${CASE_DE[i.kase]} → Adjektivendung ${e}.`}
  function buildFootnotes(i){const n=[];if(i.kase==='Dativ'&&i.gender==='plural')n.push('※ 複数与格は名詞に -n（すでに -n/-s なら不要）');if(i.kase==='Genitiv'&&(i.gender==='masculine'||i.gender==='neuter'))n.push('※ 男性・中性の単数属格は名詞に -s/-es');return n.length?`<div class="footnotes">${n.join('<br>')}</div>`:''}
  function buildRightCaseList(t){if(!t)return'';const r=CASE_ORDER.map(c=>({jp:CASE_JP_NUM[c],end:t[c]}));return`<div class="caseList">${r.map(c=>`<div class="case"><div class="label">${c.jp}</div><div class="ending">${c.end}</div></div>`).join('')}</div>`}
  function buildExampleLine(article,gender,kase){const end=MINI_TABLE[article][gender][kase];const cls=endClassFrom(end);const adj=ADJ_STEM+`<span class="end ${cls}">${end.replace('-','')}</span>`;const set=(article==='indefinite')?EXAMPLE_NOUNS.indefinite:EXAMPLE_NOUNS.default;let det='';if(article==='definite')det=DETERMINER.definite[gender][kase];else if(article==='indefinite')det=DETERMINER.indefinite[gender][kase];const n=set[gender];let noun='';if(gender==='plural'){noun=(kase==='Dativ')?n.datpl:(kase==='Genitiv'?n.genpl:n.base)}else if(gender==='masculine'||gender==='neuter'){noun=(kase==='Genitiv')?n.gen:n.base}else{noun=n.base}return{kase,text:`<div class="ex-row"><span class="ex-det">${det||''}</span><span class="ex-adj">${adj}</span><span class="ex-noun">${noun||''}</span></div>`}}
  function computeGlobalExampleLayout(){try{const m=document.createElement('div');m.style.cssText='position:absolute;visibility:hidden;left:-9999px;top:-9999px';document.body.appendChild(m);const a=['definite','indefinite','none'],g=['masculine','neuter','feminine','plural'],c=['Nominativ','Akkusativ','Dativ','Genitiv'];let maxD=0,maxA=0,maxT=0,maxTP=0;const f=(A,G,K)=>{const l=buildExampleLine(A,G,K),w=document.createElement('div');w.className='ex-cell';w.innerHTML=l.text;return w};a.forEach(A=>{g.forEach(G=>{c.forEach(K=>{const C=f(A,G,K);m.appendChild(C);const d=C.querySelector('.ex-det'),j=C.querySelector('.ex-adj');const wD=d?d.getBoundingClientRect().width:0;const wA=j?j.getBoundingClientRect().width:0;if(wD>maxD)maxD=wD;if(wA>maxA)maxA=wA;m.removeChild(C)})})});const b=['Kasus','Nom.','Akk.','Dat.','Gen.'];let maxCC=0;b.forEach(t=>{const T=document.createElement('table');T.className='ex-table';const r=document.createElement('tr');const d1=document.createElement('td');d1.textContent=t;r.appendChild(d1);const d2=document.createElement('td');d2.textContent='X';r.appendChild(d2);T.appendChild(r);m.appendChild(T);const w=d1.getBoundingClientRect().width;if(w>maxCC)maxCC=w;m.removeChild(T)});const h=(A,G)=>{const t=document.createElement('table');t.className='ex-table';const d=document.createElement('thead');d.innerHTML='<tr><th>Kasus</th><th>Beispiel</th></tr>';t.appendChild(d);const y=document.createElement('tbody');c.forEach(K=>{const r=document.createElement('tr');const d1=document.createElement('td');d1.textContent={Nominativ:'Nom.',Akkusativ:'Akk.',Dativ:'Dat.',Genitiv:'Gen.'}[K];r.appendChild(d1);const d2=document.createElement('td');d2.className='ex-cell';const i=f(A,G,K);d2.appendChild(i);r.appendChild(d2);y.appendChild(r)});t.appendChild(y);return t};a.forEach(A=>{g.forEach(G=>{const t=h(A,G);m.appendChild(t);const w=t.getBoundingClientRect().width;if(w>maxT)maxT=w;if(G==='plural'&&w>maxTP)maxTP=w;m.removeChild(t)})});EX_GLOBAL={det:Math.ceil(maxD),adj:Math.ceil(maxA),table:Math.ceil(maxTP||maxT),caseCol:Math.ceil(maxCC)};const e=document.getElementById('exampleView');if(e){e.style.setProperty('--det-w',EX_GLOBAL.det+'px');e.style.setProperty('--adj-w',EX_GLOBAL.adj+'px');e.style.minWidth=(EX_GLOBAL.table+16)+'px';const t=e.querySelector('table.ex-table');if(t){t.style.width=(EX_GLOBAL.table+16)+'px'}}document.body.removeChild(m)}catch(_e){}}
  function alignExampleColumns(){const ev=document.getElementById('exampleView');if(!ev||!EX_GLOBAL)return;ev.style.setProperty('--det-w',EX_GLOBAL.det+'px');ev.style.setProperty('--adj-w',EX_GLOBAL.adj+'px');ev.style.minWidth=(EX_GLOBAL.table+16)+'px'}
  function showExamples(a,g){const e=document.getElementById('exampleView'),h=`${LABEL_JP.gender[g]}（${LABEL_JP.article[a]}＋形容詞＋名詞）`,r=CASE_ORDER.map(c=>{const l=buildExampleLine(a,g,c),L=CASE_ABBR[l.kase],R=l.text;return`<tr><td>${L}</td><td class="ex-cell">${R}</td></tr>`}).join(''),w=EX_GLOBAL&&EX_GLOBAL.caseCol?EX_GLOBAL.caseCol:72;e.innerHTML=`<h4>${h}</h4><table class="ex-table"><colgroup><col style="width:${w}px"><col></colgroup><thead><tr><th>Kasus</th><th>Beispiel</th></tr></thead><tbody>${r}</tbody></table>`;const t=e.querySelector('table.ex-table');if(t)t.style.width=EX_GLOBAL&&EX_GLOBAL.table?EX_GLOBAL.table+16:e.offsetWidth||320+'px';e.hidden=false;requestAnimationFrame(()=>{computeGlobalExampleLayout();alignExampleColumns()})}
  function buildReferenceTable(a){const t=MINI_TABLE[a],e=document.createElement('table');e.className='ref-table';const d=document.createElement('thead'),h=document.createElement('tr');h.innerHTML=`<th></th>${GENDER_ORDER.map(g=>`<th>${GENDER_JP_SHORT[g]}</th>`).join('')}`;d.appendChild(h);e.appendChild(d);const y=document.createElement('tbody');CASE_ORDER.forEach(c=>{const r=document.createElement('tr'),s=GENDER_ORDER.map(g=>{const v=t[g][c],l=v==='-en'&&(a==='definite'||a==='indefinite')?' class="en-bg"':'';return`<td${l}>${v}</td>`}).join('');r.innerHTML=`<td><strong>${CASE_JP_NUM[c]}</strong></td>`+s;y.appendChild(r)});e.appendChild(y);return e}
  function applyGenderHighlight(){const w=document.getElementById('refTableWrap'),t=w&&w.querySelector('table.ref-table');if(!t)return;t.classList.remove('hl-masculine','hl-neuter','hl-feminine','hl-plural');void t.offsetWidth;t.classList.add('hl-'+currentGender);const h=t.querySelector('thead tr');if(!h)return;const s=h.querySelectorAll('th');s.forEach(e=>e.classList.remove('flash'));const i={masculine:1,neuter:2,feminine:3,plural:4},T=s[i[currentGender]];if(T){void T.offsetWidth;T.classList.add('flash')}}
  function mountRef(a='definite'){currentArticle=a;const t=document.querySelectorAll('.ref-tabs button');t.forEach(b=>b.classList.toggle('active',b.dataset.article===a));const w=document.getElementById('refTableWrap');w.innerHTML='';const c=document.getElementById('refControls');c.innerHTML='';const g=[{key:'masculine',label:'男性名詞'},{key:'neuter',label:'中性名詞'},{key:'feminine',label:'女性名詞'},{key:'plural',label:'複数形'}];g.forEach(e=>{const b=document.createElement('button');b.textContent=e.label;b.dataset.gender=e.key;if(e.key===currentGender)b.classList.add('active');b.onclick=()=>{currentGender=e.key;c.querySelectorAll('button').forEach(x=>x.classList.remove('active'));b.classList.add('active');showExamples(a,e.key);applyGenderHighlight();checkEasterEgg()};c.appendChild(b)});showExamples(a,currentGender);w.appendChild(buildReferenceTable(a));applyGenderHighlight()}
  
  // --- Rewards & Animations ---
  const STREAK_BADGES={2:'Gut! いいね！',3:'Prima! すてき！',4:'Toll! すごい！',5:'Super! 最高！',6:'Klasse! 素晴らしい！',7:'Spitze! 抜群だ！',8:'Stark! さすが！',9:'Bravo! ブラボー！',10:'Genial! 天才的だ！',20:'Wahnsinn! 半端ない！',30:'Fantastisch! 素晴らしい！',40:'Ausgezeichnet! 秀逸だ！',50:'Legendär! 伝説的だ！',60:'Galaktisch! 銀河級だ！',70:'Göttlich! 神業だ！',80:'Kosmisch! 宇宙レベル！',90:'Nicht von dieser Welt!',100:'Sprachmeister!'};
  function colorKeyForStreak(s){if(s>=100)return'meister';if(s>=90)return'godlike';if(s>=80)return'mythic';if(s>=70)return'legendary';if(s>=60)return'epic';if(s>=50)return'black';if(s>=40)return'red';if(s>=30)return'orange';if(s>=20)return'yellow';if(s>=10)return'lime';if(s>=5)return'green';if(s>=4)return'sky';if(s>=3)return'indigo';if(s>=2)return'purple';return'accent'}
  function buildStreakBadge(s){let l=0;for(const k in STREAK_BADGES){const m=parseInt(k,10);if(s>=m&&m>l)l=m}if(l===0)return'';let msg=STREAK_BADGES[l];const t=colorKeyForStreak(l);return`<span class="streak-badge tone-${t}" title="${s}連続正解">${msg}</span>`}
  function triggerPulse(s){const c=document.getElementById('quiz');if(!c)return;c.classList.remove('pulse');void c.offsetWidth;c.classList.add('pulse');clearTimeout(c._pulseTimer);c._pulseTimer=setTimeout(()=>{c.classList.remove('pulse')},900)}
  function showCherryBlossoms(){const c=document.getElementById('fullscreen-reward');if(!c)return;const o=['#ffb7c5','#ffc0cb','#ffe4e1','#fff0f5'];const pC=70;for(let i=0;i<pC;i++){const p=document.createElement('div');p.className='particle petal';p.style.left=Math.random()*100+'vw';const d=5+Math.random()*4,a=Math.random()*5;p.style.animationDuration=`${d}s`;p.style.animationDelay=`${a}s`;p.style.backgroundColor=o[Math.floor(Math.random()*o.length)];p.style.setProperty('--sway',`${Math.random()*50-25}px`);p.style.setProperty('--r-start',`${Math.random()*360}deg`);c.appendChild(p)}}
  function showGoldenPetals(){const c=document.getElementById('fullscreen-reward');if(!c)return;const o=['#ffd700', '#f0e68c', '#fffacd', '#fafad2'];const pC=70;for(let i=0;i<pC;i++){const p=document.createElement('div');p.className='particle petal';p.style.left=Math.random()*100+'vw';const d=5+Math.random()*4,a=Math.random()*5;p.style.animationDuration=`${d}s`;p.style.animationDelay=`${a}s`;p.style.backgroundColor=o[Math.floor(Math.random()*o.length)];p.style.setProperty('--sway',`${Math.random()*50-25}px`);p.style.setProperty('--r-start',`${Math.random()*360}deg`);c.appendChild(p)}}
  function showConfetti(){const c=document.getElementById('fullscreen-reward');if(!c)return;const o=['#f44336','#e91e63','#9c27b0','#673ab7','#3f51b5','#2196f3','#03a9f4','#00bcd4','#009688','#4caf50','#8bc34a','#cddc39','#ffeb3b','#ffc107','#ff9800','#ff5722'];const cC=100;for(let i=0;i<cC;i++){const f=document.createElement('div');f.className='particle confetti';f.style.left=Math.random()*100+'vw';const d=2+Math.random()*2,a=Math.random()*5;f.style.animationDuration=`${d}s`;f.style.animationDelay=`${a}s`;f.style.backgroundColor=o[Math.floor(Math.random()*o.length)];f.style.setProperty('--rx',`${Math.random()*720}deg`);f.style.setProperty('--ry',`${Math.random()*720}deg`);c.appendChild(f)}}
  function showGoldSilverConfetti(){const c=document.getElementById('fullscreen-reward');if(!c)return;const o=['#ffd700','#c0c0c0','#f0e68c'];const cC=100;for(let i=0;i<cC;i++){const f=document.createElement('div');f.className='particle confetti';f.style.left=Math.random()*100+'vw';const d=2+Math.random()*2,a=Math.random()*5;f.style.animationDuration=`${d}s`;f.style.animationDelay=`${a}s`;f.style.backgroundColor=o[Math.floor(Math.random()*o.length)];f.style.setProperty('--rx',`${Math.random()*720}deg`);f.style.setProperty('--ry',`${Math.random()*720}deg`);c.appendChild(f)}}
  function showSilverConfetti(){const c=document.getElementById('fullscreen-reward');if(!c)return;const o=['#c0c0c0','#e0e0e0','#f5f5f5','#d3d3d3'];const cC=100;for(let i=0;i<cC;i++){const f=document.createElement('div');f.className='particle confetti';f.style.left=Math.random()*100+'vw';const d=3+Math.random()*3,a=Math.random()*5;f.style.animationDuration=`${d}s`;f.style.animationDelay=`${a}s`;f.style.backgroundColor=o[Math.floor(Math.random()*o.length)];f.style.setProperty('--rx',`${Math.random()*720}deg`);f.style.setProperty('--ry',`${Math.random()*720}deg`);c.appendChild(f)}}
  function showSnowflakes(){const c=document.getElementById('fullscreen-reward');if(!c)return;const k=['❄','❅','❆'];const sC=150;for(let i=0;i<sC;i++){const s=document.createElement('div');s.className='particle snowflake';s.textContent=k[Math.floor(Math.random()*k.length)];s.style.left=Math.random()*100+'vw';const d=8+Math.random()*7,a=(Math.random()*15);s.style.animationDuration=`${d}s`;s.style.animationDelay=`${a}s`;s.style.animationIterationCount='infinite';s.style.fontSize=`${12+Math.random()*18}px`;s.style.setProperty('--sway',`${Math.random()*80-40}px`);s.style.setProperty('--r-start',`${Math.random()*360}deg`);c.appendChild(s)}}
  function showFireworksExplosions(){const c=document.getElementById('fullscreen-reward');if(!c)return;const fC=40,o=['#ff4500','#ff8c00','#ffd700','#adff2f','#00ced1','#1e90ff','#da70d6','#ff1493'];for(let i=0;i<fC;i++){const e=document.createElement('div');e.className='explosion';e.style.left=`${10+Math.random()*80}%`;e.style.top=`${10+Math.random()*80}%`;const pC=150;for(let j=0;j<pC;j++){const p=document.createElement('div');p.className='particle';p.style.backgroundColor=o[Math.floor(Math.random()*o.length)];const a=Math.random()*360,d=250+Math.random()*150;p.style.setProperty('--explode-x',`${Math.cos(a*Math.PI/180)*d}px`);p.style.setProperty('--explode-y',`${Math.sin(a*Math.PI/180)*d}px`);p.style.animationDelay=`${Math.random()*9}s`;e.appendChild(p)}c.appendChild(e)}}
  function showBubbles(){const c=document.getElementById('fullscreen-reward');if(!c)return;const bC=40;for(let i=0;i<bC;i++){const b=document.createElement('div');b.className='particle bubble';const s=10+Math.random()*40;b.style.width=`${s}px`;b.style.height=`${s}px`;b.style.left=`${Math.random()*100}vw`;b.style.top=`${100+Math.random()*20}vh`;b.style.animationDelay=`${Math.random()*5}s`;b.style.animationDuration=`${5+Math.random()*8}s`;b.style.setProperty('--wobble',`${Math.random()*200-100}px`);c.appendChild(b)}}
  function showFullscreenReward(){const c=document.getElementById('fullscreen-reward');if(!c)return;c.innerHTML=`<div id="fullscreen-reward-content"><h1>${STREAK_BADGES[100]}</h1></div>`;c.style.background='rgba(0, 0, 0, 0.7)';c.style.pointerEvents='auto';c.hidden=false;void c.offsetWidth;c.classList.add('visible');showGoldenPetals();setTimeout(()=>{c.classList.remove('visible');c.innerHTML='';c.hidden=true},10000)}
  function show90StreakReward(){const c=document.getElementById('fullscreen-reward');if(!c)return;const t=STREAK_BADGES[90].replace('<br>',' ');c.innerHTML=`<div id="fullscreen-reward-content"><h1 class="silver">${t}</h1></div>`;c.style.background='rgba(10,10,30,0.7)';c.style.pointerEvents='auto';c.hidden=false;void c.offsetWidth;c.classList.add('visible');showSilverConfetti();setTimeout(()=>{c.classList.remove('visible');c.innerHTML='';c.hidden=true},10000)}
  function unlockSprachmeisterBadge(){if(sprachmeisterUnlocked)return;const a=document.getElementById('achievements'),t=document.getElementById('trophy-case');if(!a||!t)return;const c=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="M5 16L3 5l5.5 5L12 4l3.5 6L21 5l-2 11H5m14 3c0 .6-.4 1-1 1H6c-.6 0-1-.4-1-1v-1h14v1Z"/></svg>`;const n=`<div class="trophy-badge" title="100連続正解おめでとうございます！">${c}<span>Sprachmeister!</span></div>`;t.innerHTML+=n;a.hidden=false;sprachmeisterUnlocked=true}

  // --- Initializers & Binders ---
  function checkEasterEgg() {
    try {
        const allFiltersCleared = Array.from(document.querySelectorAll('#filterPanel input[type="checkbox"]')).every(chk => !chk.checked);
        const isNoneArticle = document.querySelector('.ref-tabs button[data-article="none"]')?.classList.contains('active');
        const isPluralGender = document.querySelector('#refControls button[data-gender="plural"]')?.classList.contains('active');
        const testControls = document.getElementById('test-controls');

        if (testControls) {
            testControls.hidden = !(allFiltersCleared && isNoneArticle && isPluralGender);
        }
    } catch (e) {
        // Fail silently if elements don't exist yet
    }
  }

  function setupTestButtons(){
    const runAnimation=(f, bg='transparent')=>{const c=document.getElementById('fullscreen-reward');if(c){c.innerHTML='';c.style.background=bg;c.style.pointerEvents='none';c.hidden=false;void c.offsetWidth;c.classList.add('visible');f();setTimeout(()=>{c.classList.remove('visible');c.innerHTML='';c.hidden=true},5000)}};
    document.getElementById('test-streak-10')?.addEventListener('click',()=>{triggerPulse(10);const e=document.getElementById('exp'),s=buildStreakBadge(10);e.innerHTML=`<div class="result-full"><p class="result-line">${s}</p></div>`;e.hidden=false});
    document.getElementById('test-streak-60')?.addEventListener('click',()=>runAnimation(showCherryBlossoms));
    document.getElementById('test-confetti')?.addEventListener('click',()=>runAnimation(showConfetti));
    document.getElementById('test-gold-silver')?.addEventListener('click',()=>runAnimation(showGoldSilverConfetti));
    document.getElementById('test-snowflakes')?.addEventListener('click',()=>runAnimation(showSnowflakes, 'rgba(25, 25, 50, 0.5)'));
    document.getElementById('test-bubbles')?.addEventListener('click',()=>runAnimation(showBubbles, 'radial-gradient(circle at top, #87CEEB, #1E90FF)'));
    document.getElementById('test-fireworks')?.addEventListener('click',()=>runAnimation(showFireworksExplosions, 'rgba(0, 0, 10, 0.7)'));
    document.getElementById('test-streak-90')?.addEventListener('click',()=>show90StreakReward());
    document.getElementById('test-streak-100')?.addEventListener('click',()=>{showFullscreenReward();unlockSprachmeisterBadge()});
  }

  function initFilterControls(){
    const c=document.getElementById('caseChecks'),a=document.getElementById('articleChecks'),g=document.getElementById('genderChecks');
    readAndApply=()=>{c.querySelectorAll('input[type="checkbox"]').forEach(i=>{state.filters.cases[i.dataset.case]=i.checked});a.querySelectorAll('input[type="checkbox"]').forEach(i=>{state.filters.articles[i.dataset.article]=i.checked});g.querySelectorAll('input[type="checkbox"]').forEach(i=>{state.filters.genders[i.dataset.gender]=i.checked});updateLevelSelectionFromCases();const l=LEVEL_CASES[state.level]||CASE_ORDER;let t=ITEMS.filter(i=>l.includes(i.kase));t=t.filter(i=>state.filters.cases[i.kase]&&state.filters.articles[i.article]&&state.filters.genders[i.gender]);if(t.length===0){state.filters.cases={Nominativ:true,Akkusativ:false,Dativ:false,Genitiv:false};state.filters.articles={definite:true,indefinite:false,none:false};state.filters.genders={masculine:true,neuter:false,feminine:false,plural:false};const s=document.getElementById('levelSeg');s.querySelectorAll('button').forEach(b=>b.classList.remove('active'));s.querySelector('button[data-level="All"]').classList.add('active');state.level='All'}buildPool();render(); checkEasterEgg();};
    [c,a,g].forEach(b=>{b.querySelectorAll('input[type="checkbox"]').forEach(i=>i.addEventListener('change',readAndApply))});
    document.getElementById('selectAllFilters').addEventListener('click',()=>{document.querySelectorAll('#filterPanel input[type="checkbox"]').forEach(c=>c.checked=true);readAndApply()});
    document.getElementById('clearAllFilters').addEventListener('click',()=>{document.querySelectorAll('#filterPanel input[type="checkbox"]').forEach(c=>c.checked=false);readAndApply()});
  }

  function updateLevelSelectionFromCases(){const c={Nominativ:document.querySelector('#caseChecks input[data-case="Nominativ"]').checked,Akkusativ:document.querySelector('#caseChecks input[data-case="Akkusativ"]').checked,Dativ:document.querySelector('#caseChecks input[data-case="Dativ"]').checked,Genitiv:document.querySelector('#caseChecks input[data-case="Genitiv"]').checked};const i=c.Nominativ&&c.Akkusativ&&c.Dativ&&c.Genitiv;const a=c.Nominativ&&c.Akkusativ&&c.Dativ&&!c.Genitiv;const s=!c.Nominativ&&!c.Akkusativ&&!c.Dativ&&c.Genitiv;const l=document.getElementById('levelSeg');l.querySelectorAll('button').forEach(b=>b.classList.remove('active'));let n='All';if(i){l.querySelector('button[data-level="All"]').classList.add('active');n='All'}else if(a){l.querySelector('button[data-level="A1+A2"]').classList.add('active');n='A1+A2'}else if(s){l.querySelector('button[data-level="B1"]').classList.add('active');n='B1'}else{l.querySelector('button[data-level="All"]').classList.add('active');n='All'}state.level=n}
  function updateCheckboxesFromLevel(l){const c=document.querySelectorAll('#caseChecks input[type="checkbox"]');const s={'All':['Nominativ','Akkusativ','Dativ','Genitiv'],'A1+A2':['Nominativ','Akkusativ','Dativ'],'B1':['Genitiv']};const t=s[l]||[];c.forEach(h=>{h.checked=t.includes(h.dataset.case)})}
  function bindLevelSeg(){document.getElementById('levelSeg').querySelectorAll('button').forEach(b=>{b.addEventListener('click',()=>{const l=b.dataset.level;const n=Array.from(document.querySelectorAll('#articleChecks input')).some(c=>!c.checked)||Array.from(document.querySelectorAll('#genderChecks input')).some(c=>!c.checked);if(n)document.querySelectorAll('#articleChecks input, #genderChecks input').forEach(c=>c.checked=true);updateCheckboxesFromLevel(l);readAndApply()})}) }
  function bindRefTabs(){document.querySelectorAll('.ref-tabs button').forEach(b=>b.addEventListener('click',()=>{document.querySelectorAll('.ref-tabs button').forEach(t=>t.classList.remove('active'));b.classList.add('active');mountRef(b.dataset.article);checkEasterEgg()}))}

  function start(){
    try{
      initFilterControls();
      bindLevelSeg();
      buildPool();
      render();
      bindRefTabs();
      mountRef('definite');
      setupTestButtons(); 
      if(document.fonts&&document.fonts.ready){
        document.fonts.ready.then(()=>{computeGlobalExampleLayout();mountRef(currentArticle||'definite');alignExampleColumns();fillAllBlanks()})
      }
      window.addEventListener('resize',()=>{fitChoiceText();scaleChoices();computeGlobalExampleLayout();alignExampleColumns();fillAllBlanks()});
      setTimeout(()=>{const q=document.getElementById('q');if(q&&(!q.textContent||q.textContent.includes('読み込み中')))render()},200)
    } catch(e){
      showError('初期化エラー：'+(e&&e.message?e.message:e))
    }
  }
  
  if(document.readyState==='loading')document.addEventListener('DOMContentLoaded',start,{once:true});
  else start();
</script>
</body>
</html>
